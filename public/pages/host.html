<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="/js/common.js"></script>
    <script src="/js/particles.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="/index.css" />
    <link rel="stylesheet" href="/styles/loader.css">
    <link rel="stylesheet" href="/styles/template.css">
    <meta name="googlebot" content="index, follow, snippet" />
    <link rel="shortcut icon" content="favicon.ico" />
    <script src="/baremux/index.js" defer></script>
    <script src="/epoxy/index.js" defer></script>
    <script src="/libcurl/index.js" defer></script>
    <script src="/uv/uv.bundle.js" defer></script>
    <script src="/uv/uv.config.js" defer></script>
    <script src="/js/uv/register-sw.js" defer></script>
    <script src="/js/uv/search.js" defer></script>

  </head>
<body>
   <div id="canvas-container" style="display: none;"></div>
    <div class="grain-overlay" style="display: none;"></div>
  <div id="particles-js" style="display: none;"></div>
  
  <div id="gameContainer">
    <div class="game-header">
      <div class="game-title" id="gameTitle">Loading...</div>
      <div class="button-group">
        <button class="game-btn" id="openNewTabBtn" title="Open in New Tab">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </button>
        <button class="game-btn" id="fullscreenBtn" title="Fullscreen">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
        </button>
      </div>
    </div>
    <iframe id="gameIframe" allowfullscreen allow="keyboard *"></iframe>
  </div>

  <script src="../js/canvas.js"></script>
</body>
<script>
const qs = window.location.search;
const urlParams = new URLSearchParams(qs);

let src = urlParams.get('src');
let type = urlParams.get('type');
let title = decodeURIComponent(urlParams.get('title') || 'Game');

document.getElementById('gameTitle').textContent = title;

async function registerServiceWorker(url){
  let connection = new BareMux.BareMuxConnection("/baremux/worker.js")

  try {
    await registerSW();
  } catch (err) {
    console.error(err)
  }

  let wispUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/";
  if (!localStorage.getItem('proxy-transport')){
    await connection.setTransport("/libcurl/index.mjs", [{ wisp: wispUrl }]);
  } else{
    console.log("Setting transport to " + localStorage.getItem('proxy-transport'))
    if (localStorage.getItem('proxy-transport') === "Epoxy"){
      await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
    }
    if (localStorage.getItem('proxy-transport') === "Libcurl"){
      await connection.setTransport("/libcurl/index.mjs", [{ wisp: wispUrl }]);
    }
  }
}

const xorEncode = {
    encode(str) {
        if (!str) return str;
        return encodeURIComponent(
            str
                .toString()
                .split('')
                .map((char, ind) =>
                    ind % 2 ? String.fromCharCode(char.charCodeAt() ^ 2) : char
                 )
                .join('')
        );
    }
};

function loadGame(){
  let returnValue
  if (type == 'iframe'){
    returnValue = decodeURIComponent(src);
  } else if (type == 'html'){
    returnValue = `/files/games${src}`
  } else if (type == 'flash'){
    returnValue = `/files/embeds/ruffle.html?src=${src}`
  } else if (type == 'proxy'){
    returnValue = `/@/` + xorEncode.encode(src)
  } else if (type == 'method'){
    returnValue = `/files/methods${src}`
  } else {
    returnValue = `/files/embeds/emujs/index.html?game=${src}&?core=${type}`
  }
  return returnValue;
}

const gameUrl = loadGame();
const iframe = document.getElementById('gameIframe');
iframe.src = gameUrl;


document.getElementById('openNewTabBtn').addEventListener('click', function() {
  window.open(gameUrl, '_blank');
});


document.getElementById('fullscreenBtn').addEventListener('click', function() {
  if (iframe.requestFullscreen) {
    iframe.requestFullscreen();
  } else if (iframe.webkitRequestFullscreen) {
    iframe.webkitRequestFullscreen();
  } else if (iframe.mozRequestFullScreen) {
    iframe.mozRequestFullScreen();
  } else if (iframe.msRequestFullscreen) {
    iframe.msRequestFullscreen();
  }
});

if (type == 'proxy'){
  registerServiceWorker();
}
</script>
</html>